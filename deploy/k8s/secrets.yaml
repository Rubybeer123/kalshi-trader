# CronJob for API Key Rotation
# Rotates API keys on a schedule (requires external secret management)

apiVersion: batch/v1
kind: CronJob
metadata:
  name: kalshi-key-rotation
  namespace: kalshi-trader
spec:
  # Run weekly on Sunday at 3 AM
  schedule: "0 3 * * 0"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: kalshi-trader
          restartPolicy: OnFailure
          containers:
            - name: key-rotation
              image: bitnami/kubectl:latest
              command:
                - /bin/sh
                - -c
                - |
                  echo "Key rotation would happen here"
                  echo "This is a placeholder - implement with your secret management solution"
                  echo "Options: AWS Secrets Manager, HashiCorp Vault, Azure Key Vault, etc."
                  
                  # Example with external secret operator:
                  # kubectl annotate secret kalshi-private-key force-sync="$(date +%s)"
              
              securityContext:
                allowPrivilegeEscalation: false
                runAsNonRoot: true
                capabilities:
                  drop:
                    - ALL
              
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "50m"
                limits:
                  memory: "128Mi"
                  cpu: "100m"

---
# External Secret configuration for AWS Secrets Manager
# Requires: https://external-secrets.io/
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: kalshi-trader-external-secret
  namespace: kalshi-trader
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: kalshi-trader-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      data:
        KALSHI_API_KEY_ID: "{{ .api_key_id }}"
  data:
    - secretKey: api_key_id
      remoteRef:
        key: kalshi-trader/production
        property: api_key_id

---
# External Secret for Private Key
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: kalshi-private-key-external
  namespace: kalshi-trader
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-secrets-manager
  target:
    name: kalshi-private-key
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      data:
        kalshi-key.pem: "{{ .private_key }}"
  data:
    - secretKey: private_key
      remoteRef:
        key: kalshi-trader/production
        property: private_key
